{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block title %}LLM Parsing Analytics{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">{% trans 'Home' %}</a>
    &rsaquo; <a href="{% url 'admin:accounts_llmparsinglog_changelist' %}">LLM Parsing Logs</a>
    &rsaquo; Analytics
</div>
{% endblock %}

{% block content %}
<div style="margin-bottom: 20px;">
    <form method="get" style="display: inline-block;">
        <label for="days">Period:</label>
        <select name="days" id="days" onchange="this.form.submit()">
            <option value="7" {% if analytics.period_days == 7 %}selected{% endif %}>Last 7 days</option>
            <option value="30" {% if analytics.period_days == 30 %}selected{% endif %}>Last 30 days</option>
            <option value="90" {% if analytics.period_days == 90 %}selected{% endif %}>Last 90 days</option>
            <option value="365" {% if analytics.period_days == 365 %}selected{% endif %}>Last year</option>
        </select>
    </form>
</div>

<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
    <div style="border: 1px solid #ddd; padding: 20px; border-radius: 5px; background: #f9f9f9;">
        <h3 style="margin-top: 0; color: #666;">Total Requests</h3>
        <div style="font-size: 36px; font-weight: bold; color: #333;">{{ analytics.total_requests }}</div>
    </div>
    
    <div style="border: 1px solid #4CAF50; padding: 20px; border-radius: 5px; background: #f1f8f4;">
        <h3 style="margin-top: 0; color: #4CAF50;">Successful</h3>
        <div style="font-size: 36px; font-weight: bold; color: #4CAF50;">{{ analytics.successful_requests }}</div>
    </div>
    
    <div style="border: 1px solid #f44336; padding: 20px; border-radius: 5px; background: #fff5f5;">
        <h3 style="margin-top: 0; color: #f44336;">Failed</h3>
        <div style="font-size: 36px; font-weight: bold; color: #f44336;">{{ analytics.failed_requests }}</div>
    </div>
    
    <div style="border: 1px solid #2196F3; padding: 20px; border-radius: 5px; background: #f0f7ff;">
        <h3 style="margin-top: 0; color: #2196F3;">Success Rate</h3>
        <div style="font-size: 36px; font-weight: bold; color: #2196F3;">{{ analytics.success_rate }}%</div>
    </div>
    
    <div style="border: 1px solid #FF9800; padding: 20px; border-radius: 5px; background: #fff8f0;">
        <h3 style="margin-top: 0; color: #FF9800;">Avg Response Time</h3>
        <div style="font-size: 36px; font-weight: bold; color: #FF9800;">
            {% if analytics.avg_response_time_ms %}
                {% if analytics.avg_response_time_ms < 1000 %}
                    {{ analytics.avg_response_time_ms|floatformat:0 }} ms
                {% else %}
                    {% widthratio analytics.avg_response_time_ms 1000 1 %} s
                {% endif %}
            {% else %}
                -
            {% endif %}
        </div>
    </div>
</div>

{% if analytics.error_breakdown %}
<div style="margin-bottom: 30px;">
    <h2>Error Breakdown</h2>
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="background: #f5f5f5;">
                <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Error Type</th>
                <th style="padding: 10px; text-align: right; border: 1px solid #ddd;">Count</th>
                <th style="padding: 10px; text-align: right; border: 1px solid #ddd;">Percentage</th>
            </tr>
        </thead>
        <tbody>
            {% for error in analytics.error_breakdown %}
            <tr>
                <td style="padding: 10px; border: 1px solid #ddd;">{{ error.error_type|title }}</td>
                <td style="padding: 10px; text-align: right; border: 1px solid #ddd;">{{ error.count }}</td>
                <td style="padding: 10px; text-align: right; border: 1px solid #ddd;">
                    {% if analytics.failed_requests > 0 %}
                        {% widthratio error.count analytics.failed_requests 100 %}%
                    {% else %}
                        0%
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

{% if analytics.provider_stats %}
<div style="margin-bottom: 30px;">
    <h2>Provider/Model Performance</h2>
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="background: #f5f5f5;">
                <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Provider</th>
                <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Model</th>
                <th style="padding: 10px; text-align: right; border: 1px solid #ddd;">Total</th>
                <th style="padding: 10px; text-align: right; border: 1px solid #ddd;">Successful</th>
                <th style="padding: 10px; text-align: right; border: 1px solid #ddd;">Success Rate</th>
                <th style="padding: 10px; text-align: right; border: 1px solid #ddd;">Avg Response Time</th>
            </tr>
        </thead>
        <tbody>
            {% for stat in analytics.provider_stats %}
            <tr>
                <td style="padding: 10px; border: 1px solid #ddd;">{{ stat.llm_provider|title }}</td>
                <td style="padding: 10px; border: 1px solid #ddd;">{{ stat.llm_model }}</td>
                <td style="padding: 10px; text-align: right; border: 1px solid #ddd;">{{ stat.total }}</td>
                <td style="padding: 10px; text-align: right; border: 1px solid #ddd;">{{ stat.successful }}</td>
                <td style="padding: 10px; text-align: right; border: 1px solid #ddd;">
                    {% if stat.total > 0 %}
                        {% widthratio stat.successful stat.total 100 %}%
                    {% else %}
                        0%
                    {% endif %}
                </td>
                <td style="padding: 10px; text-align: right; border: 1px solid #ddd;">
                    {% if stat.avg_response_time %}
                        {% if stat.avg_response_time < 1000 %}
                            {{ stat.avg_response_time|floatformat:0 }} ms
                        {% else %}
                            {% widthratio stat.avg_response_time 1000 1 %} s
                        {% endif %}
                    {% else %}
                        -
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<div style="margin-bottom: 30px;">
    <h2>Daily Statistics</h2>
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="background: #f5f5f5;">
                <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Date</th>
                <th style="padding: 10px; text-align: right; border: 1px solid #ddd;">Total</th>
                <th style="padding: 10px; text-align: right; border: 1px solid #ddd;">Successful</th>
                <th style="padding: 10px; text-align: right; border: 1px solid #ddd;">Failed</th>
                <th style="padding: 10px; text-align: right; border: 1px solid #ddd;">Success Rate</th>
            </tr>
        </thead>
        <tbody>
            {% for day in analytics.daily_stats %}
            <tr>
                <td style="padding: 10px; border: 1px solid #ddd;">{{ day.day }}</td>
                <td style="padding: 10px; text-align: right; border: 1px solid #ddd;">{{ day.total }}</td>
                <td style="padding: 10px; text-align: right; border: 1px solid #ddd; color: #4CAF50;">{{ day.successful }}</td>
                <td style="padding: 10px; text-align: right; border: 1px solid #ddd; color: #f44336;">{{ day.failed }}</td>
                <td style="padding: 10px; text-align: right; border: 1px solid #ddd;">
                    {% if day.total > 0 %}
                        {% widthratio day.successful day.total 100 %}%
                    {% else %}
                        0%
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div style="margin-top: 30px;">
    <a href="{% url 'admin:accounts_llmparsinglog_changelist' %}" class="button">View All Logs</a>
</div>
{% endblock %}

